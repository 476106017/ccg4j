# 右键菜单与卡牌分解功能

## 功能概述

### 1. 右键菜单系统
- 引入轻量级右键菜单组件 `context-menu.js`
- 支持图标、禁用状态、分隔符
- 自动处理位置溢出

### 2. 我的卡组 - 右键删除
- 在【我的卡组】中右键点击卡牌
- 显示"从卡组中删除"选项
- 点击后从卡组移除该卡牌

### 3. 我的收藏 - 分解卡牌
- 在【我的收藏】中右键点击卡牌
- 仅当卡牌数量 > 3 时显示"分解多余卡牌"选项
- 分解后保留3张，其余转换为奥术之尘

### 4. 奥术之尘系统
**稀有度对应奥术之尘：**
- 铜卡 (BRONZE): 50
- 银卡 (SILVER): 200
- 金卡 (GOLD): 800
- 彩卡 (RAINBOW): 1600
- 传说卡 (LEGENDARY): 2400

**显示位置：**
- 在抽奖券旁边显示当前奥术之尘数量
- 分解卡牌后实时更新显示

### 5. 匹配分系统（预留）
- 数据库字段：`match_rating`
- 默认值：1000分
- 用于未来的匹配系统

## 数据库更新

### 方式一：新建表（推荐用于新数据库）
执行 `src/main/sql/user_account.sql`

### 方式二：迁移现有表（推荐用于已有数据）
执行 `src/main/sql/user_account_migration.sql`

```sql
-- 会添加两个新字段：
-- arcane_dust (默认0)
-- match_rating (默认1000)
```

## 后端API

### POST /api/user/disenchant
**功能：** 分解多余卡牌

**参数：**
- `cardCode`: 卡牌编码

**响应：**
```json
{
  "disenchantCount": 2,
  "dustGained": 100,
  "totalDust": 100,
  "remainingQuantity": 3
}
```

**业务规则：**
1. 只能分解数量 > 3 的卡牌
2. 保留3张，其余全部分解
3. 根据稀有度计算奥术之尘
4. 更新用户奥术之尘总量

## 前端集成

### 引入顺序（index.html）
```html
<script src="context-menu.js"></script>  <!-- 右键菜单库 -->
<script src="collection.js"></script>     <!-- 收藏页面逻辑 -->
<script src="deck-edit.js"></script>      <!-- 卡组编辑逻辑 -->
```

### 使用示例
```javascript
// 显示右键菜单
ContextMenu.show(event, [
  {
    icon: '✨',
    label: '分解多余卡牌',
    action: () => disenchantCard(cardCode, cardName)
  },
  {
    separator: true
  },
  {
    icon: '❌',
    label: '无法操作',
    disabled: true
  }
]);
```

## 用户体验

### 视觉提示
- 右键菜单项显示操作图标
- 菜单项禁用时显示灰色
- 分解时显示确认对话框
- 成功后显示获得的奥术之尘数量

### 安全机制
- 分解前需要用户确认
- 始终保留3张卡牌
- 服务端验证卡牌数量

## 测试步骤

1. **更新数据库**
   ```bash
   # 在 Supabase 或 PostgreSQL 中执行
   psql -h your-host -U your-user -d your-db -f src/main/sql/user_account_migration.sql
   ```

2. **启动应用**
   ```bash
   .\gradlew.bat clean build
   .\gradlew.bat bootRun
   ```

3. **测试右键菜单**
   - 访问 http://localhost
   - 登录后进入【我的收藏】
   - 在拥有4张以上的卡牌上点击右键
   - 选择"分解多余卡牌"
   - 查看奥术之尘是否增加

4. **测试卡组删除**
   - 进入【我的卡组】
   - 在卡牌上点击右键
   - 选择"从卡组中删除"
   - 确认卡牌被移除

## 注意事项

1. **数据库字段**
   - `arcane_dust` 和 `match_rating` 必须添加到数据库
   - 使用迁移脚本可安全更新已有表

2. **JavaScript 依赖**
   - `context-menu.js` 必须在其他脚本之前加载
   - 需要现代浏览器支持 (ES6+)

3. **分解规则**
   - 只能分解数量 > 3 的卡牌
   - 一次分解全部多余卡牌（不能选择数量）
   - 分解不可撤销

4. **匹配分系统**
   - 已预留 `match_rating` 字段
   - 默认1000分
   - 后续可用于匹配系统
