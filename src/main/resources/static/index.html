<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">

<head th:include="/common/common :: headJq('聊天室')">

    <meta charset="utf-8">

    <!-- 新 Bootstrap5 核心 CSS 文件 -->
    <link href="https://cdn.staticfile.org/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <!-- jQuery文件。务必在bootstrap.min.js 之前引入 -->
    <script src="https://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script>


    <!-- 最新的 Bootstrap5 核心 JavaScript 文件 -->
    <script src="https://cdn.staticfile.org/twitter-bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>

    <script src="https://cdn.bootcss.com/socket.io/2.2.0/socket.io.js"></script>
    <script src="https://cdn.bootcss.com/moment.js/2.20.1/moment.min.js"></script>
    <script src="https://cdn.bootcss.com/moment.js/2.20.1/locale/zh-cn.js"></script>
    <style>
        .popover {
            word-break: break-all;
        }
    </style>

</head>

<body>

<div id="app" style="margin-left: 100px;">
    <button type="button" class="btn" style="right:0;position:fixed;z-index:999"
            data-bs-toggle="collapse" data-bs-target="#battleInfo"><<</button>
    <div id="battleInfo" class="collapse"
         style="background-color: aliceblue; border:1px solid; right:0;position:fixed; z-index:1;white-space: pre-line;
    max-height: 800px ;overflow:auto;margin: 50px; padding: 50px;">无法获取游戏信息</div>

    <ul id="msgList" style="margin-left: -50px;"></ul>
    <b id="name"></b>
    <br/>
    <input id="msgContent" name="msgContent" onkeydown="keyDown(event)" placeholder="请输入消息" autofocus>
    <input type="button" onclick="sendMsg()" value="发送"/>
    <input type="button" onclick="cleanMsg()" value="清空"/>
    <br/>
    <input type="button" onclick="$('#msgContent').val('deck')" value="使用中的牌组"/>
    <input type="button" onclick="$('#msgContent').val('usedeck')" value="选择牌组"/>
    <br/>
    <input type="button" onclick="$('#msgContent').val('jr')" value="匹配"/>
    <input type="button" onclick="$('#msgContent').val('leave')" value="退出房间"/>
    <input type="button" onclick="$('#msgContent').val('swap')" value="换牌"/>
    <input type="button" onclick="$('#msgContent').val('chat')" value="聊天"/>
    <br/>
    <input type="button" onclick="$('#msgContent').val('play')" value="出牌"/>
    <input type="button" onclick="$('#msgContent').val('attack')" value="攻击"/>
    <input type="button" onclick="$('#msgContent').val('skill')" value="主战者技能"/>
    <input type="button" onclick="$('#msgContent').val('end')" value="结束回合"/>
    <br/>
    <br/>
    <!-- <input type="button" onclick="$('#msgContent').val('grave')" value="墓地信息"/> -->
    <!-- <br/> -->
</div>

<script type="text/javascript" th:inline="javascript">
        var userName, socket;
        var historyIndex = 0;
        var historyStack=[];
        // Socket连接
        function initIm() {
            userName = prompt("请输入用户名进入游戏大厅");
            // userName = "zdm";
            if ($.trim(userName)) {
                socket = io.connect("localhost:18089", {
                    'query': 'name=' + userName
                });

                $("#name").html("你好，"+userName);

                // 成功连接事件
                socket.on('connect', function () {});
                // 断开连接事件
                socket.on('disconnect', function () {});

                // 监听receiveMsg接收消息事件
                socket.on('receiveMsg', function (data) {
                    $('#msgList').append("<li style=\"white-space: pre-line;\">" + moment().format('HH:mm:ss') + "&nbsp;&nbsp;&nbsp;" + data+  "</li>");
                    $(function () { $("[data-bs-toggle='popover']").popover(); });
                    scrollToEnd();
                });
                socket.on('battleInfo', function (data) {
                    $('#battleInfo').html(data);
                });
            } else {
                alert("非法用户名");
            }
        }

        initIm();

        // 输入框键盘输入
        function keyDown(event) {

            if(event.keyCode==13){sendMsg();}
            if(event.keyCode==38){// up arrow
                historyIndex--;
                historyContent = historyStack.slice(historyIndex)[0];
                if(historyContent){
                    $('#msgContent').val(historyContent);
                }
            }
            if(event.keyCode==40){// dw arrow
                historyIndex++;
                historyContent = historyStack.slice(historyIndex)[0];
                if(historyIndex<0 && historyContent){
                    $('#msgContent').val(historyContent);
                }
            }

        }


        // 发送消息
        function sendMsg() {
            let input = $("#msgContent").val()
            let index = input.indexOf(" ")
            if(index==-1) index=input.length;
            let msgEvent = input.substring(0,index);
            let msgContent = input.substring(index+1,input.length);
            socket.emit(msgEvent, msgContent);
            historyStack.push(input);
            historyIndex = 0;
            $("#msgContent").val('');
            $('#msgList').append("<li style=\"background-color: #ccc;\">" + moment().format('HH:mm:ss') + "&nbsp;&nbsp;&nbsp;" + input+  "</li>");
            scrollToEnd();
        }
        // 清空消息
        function cleanMsg() {
            $('#msgList').html('');
            $('#battleInfo').html('无法获取游戏信息');
        }
        function scrollToEnd(){//滚动到底部
            var h = $(document).height()-$(window).height();
            $(document).scrollTop(h);
        }
        $(document).click(function () {
            $("[data-bs-toggle='popover']").popover("hide");
        });
	</script>

</body>

</html>
